vA;0.8
vB;0.95
vCY;43466
vCurrentYear;2019
vX;0.2
vY;0.45
vИзменениеПроданоШтук;0
vИзменениеСебестоимости;0
vИзменениеЦены;0
vКоличествоТопПродаж;6
vПорог_А;20
vПорог_В;50
vРезерв;Раз
vСегментНаРеализации;Контрагент
vСуммаРеализации;100
vТОПпросрочки;10
vЧто;0
set_ОсновныеОрганизации;"
[ООО ""Роялруф""]
"
set_ОсновныеСклады;"
'1. Независимости (RoyalRoof)', '2. RoyalRock', 'Независимости_Образцы', 'Шоурум'
"
set_ПокОстТекГод;"
[Вид продажи]=, Номенклатура=, Категория=, Склад=, Бренд=, FCY = {1}, Организация = {$(set_ОсновныеОрганизации)}
"
set_УсловияВаловаяПрибыльПоКомпании;"
[Собственные] = {0}, %ВидПродажи =- {3}, [Категория]=, [Номенклатура]=, [Бренд]=, [Контрагент]=, [Головной контрагент]=, [Тип контрагента]=
"
set_УсловияМинРентТекГод;"
[Собственные] = {0}, %ВидПродажи = {1, 2}, FCY={1}, Организация = {$(set_ОсновныеОрганизации)}
"
set_УсловияПокПрГод;"
[Собственные] = {0}, %ВидПродажи = {1, 2}, FLY={1}, Организация = {$(set_ОсновныеОрганизации)}
"
set_УсловияПокТекГод;"
[Собственные] = {0}, %ВидПродажи =- {3}, FCY={1}, Организация = {$(set_ОсновныеОрганизации)}
"
set_УсловияПродаж;"
[Собственные] = {0}, %ВидПродажи =- {3}
"
set_УсловияПродажПрогноз;"
[Собственные] = {0}, %ВидПродажи =- {3}, [Организация] = {$(set_ОсновныеОрганизации)},
[Месяц]=, [МесяцГод]=, [Год]=
"
set_УсловияСреднийЧек;"
Организация = {$(set_ОсновныеОрганизации)}, Стоимость = {""> 0""}, [Тип документа] = {'Реализация'}
//[Собственные] = {0}, %ВидПродажи = {1}, Организация = {$(set_ОсновныеОрганизации)}, Стоимость = {""> 0""}, [Тип документа] = {'Реализация'}
"
set_УсловияСравненияСоСкидками1;"
[Вид продажи] = {'Обычная продажа'}, [Собственные] = {0}, [Склад] *= {$(set_ОсновныеСклады)}
"
set_УсловияСравненияСоСкидками2;"
$(set_УсловияСравненияСоСкидками1), [Тип документа] = {'Реализация'}
"
set_УсловияPYTD;"
Год=, МесяцГод=, Месяц=, НеделяГод=, Неделя=, ГодКвартал=, День=, %Дата = {"">= $(=Floor(AddMonths(YearStart(Max(Дата)),-12))) <= $(=Floor(AddMonths(MonthEnd(Max(Дата)),-12)))""}
"
set_УсловияYTD;"
[%Дата] = {"">= $(=Floor(YearStart(Max(Дата)))) <= $(=Floor(MonthEnd(Max(Дата))))""}
"
set_УсловияYTY;"
Год=[YTY]::[Год], Месяц=[YTY]::[Месяц]
"
set_Склады;"
[Склад] = {
$(set_ОсновныеСклады), 'Производство', 'Упр_Независимости'
}
"
color_BlueGrayFon;RGB(243,248,250)
color_GL_Green;RGB(54, 154, 0)
color_GL_Red;RGB(204, 102, 119)
color_GL_Blue;RGB(68,119,170)
color_GL_Yellow;RGB(255,207,2)
color_ABCпоРейтингу;"
Aggr
(
  If
  (
    $(exp_ДоляПоказатель1) <= (vПорог_А/100) 
    and 
    $(exp_ДоляПоказатель2) <= (vПорог_А/100)
    , RGB(7,180,55)
    , If
    (
      $(exp_ДоляПоказатель1) <= (vПорог_А/100) 
      and 
      $(exp_ДоляПоказатель2) <= (vПорог_В/100)
      , RGB(170,220,21)
      , If
      (
        $(exp_ДоляПоказатель1) <= (vПорог_В/100) 
        and 
        $(exp_ДоляПоказатель2) <= (vПорог_А/100)
        , RGB(170,220,21)
        , If
        (
          $(exp_ДоляПоказатель1) > (vПорог_В/100) 
          and 
          $(exp_ДоляПоказатель2) <= (vПорог_А/100)
          , RGB(240,205,5)
          , If
          (
            $(exp_ДоляПоказатель1) <= (vПорог_А/100) 
            and 
            $(exp_ДоляПоказатель2) > (vПорог_В/100), 
            RGB(240,205,5)
            , If
            (
              $(exp_ДоляПоказатель1) <= (vПорог_В/100) 
              and 
              $(exp_ДоляПоказатель2) > (vПорог_В/100)
              , RGB(255,151,3)
              , If
              (
                $(exp_ДоляПоказатель1) > (vПорог_В/100) 
                and 
                $(exp_ДоляПоказатель2) <= (vПорог_В/100)
                , RGB(255,151,3)
                , If
                (
                  $(exp_ДоляПоказатель1) <= (vПорог_В/100) 
                  and 
                  $(exp_ДоляПоказатель2) <= (vПорог_В/100)
                  , RGB(255,234,31)
                  , RGB(255,5,3)
                )
              )
            )
          )
        )
      )
    )
  )
  , 
  $(exp_Измерение)
)
"
color_ABCпоРейтингуПоказатели;"
Aggr
(
  If
  (
    $(exp_ДоляПоказатель1) <= (vПорог_А/100)
    , RGB(7,180,55)
    , If
    (
      $(exp_ДоляПоказатель1) <= (vПорог_В/100)
      , RGB(255,234,31)
      , RGB(255,5,3)
    )
  )
  , $(exp_Измерение)
)
 "
color_ABCXYZ_измерение;"
If
(
	(
		Rangesum
		(
			Above
			(
				Aggr($(exp_Показатель), $(exp_Измерение))
				/ 
				Aggr($(exp_Показатель_total), $(exp_Измерение))
				, 0, RowNo()
			)
		)
	) 
	<= $(vA) 
	and $(exp_XYZ) <= $(vX)
	, RGB(7,180,55)
	, If
	(
		(
			Rangesum
			(
				Above
				(
					Aggr($(exp_Показатель), $(exp_Измерение))
					/ 
					Aggr($(exp_Показатель_total), $(exp_Измерение))
					, 0, RowNo()
				)
			)
		) 
		<= $(vA)
		and $(exp_XYZ) <= $(vY)
		, RGB(170,220,21)
		, If
		(
			(
				Rangesum
				(
					Above
					(
						Aggr($(exp_Показатель), $(exp_Измерение))
						/ 
						Aggr($(exp_Показатель_total), $(exp_Измерение))
						, 0, RowNo()
					)
				)
			) 
			<= $(vB)
			and $(exp_XYZ) <= $(vX)
			, RGB(170,220,21), 
			If
			(
				(
					Rangesum
					(
						Above
						(
							Aggr($(exp_Показатель), $(exp_Измерение))
							/ 
							Aggr($(exp_Показатель_total), $(exp_Измерение))
							, 0, RowNo()
						)
					)
				) 
				<= $(vA)
				and $(exp_XYZ) > $(vY)
				, RGB(240,205,5)
				, If
				(
					(
						Rangesum
						(
							Above
							(
								Aggr($(exp_Показатель), $(exp_Измерение))
								/ 
								Aggr($(exp_Показатель_total), $(exp_Измерение))
								, 0, RowNo()
							)
						)
					) 
					> $(vB) 
					and $(exp_XYZ) <= $(vX)
					, RGB(240,205,5)
					, If
					(
						(
							Rangesum
							(
								Above
								(
									Aggr($(exp_Показатель), $(exp_Измерение)) 
									/ 
									Aggr($(exp_Показатель_total), $(exp_Измерение))
									, 0, RowNo()
								)
							)
						) 
						<= $(vB) 
						and $(exp_XYZ) > $(vY)
						, RGB(255,151,3)
						, If
						(
							(
								Rangesum
								(
									Above
									(
										Aggr($(exp_Показатель), $(exp_Измерение))
										/ 
										Aggr($(exp_Показатель_total), $(exp_Измерение))
										, 0, RowNo()
									)
								)
							) 
							> $(vB) 
							and $(exp_XYZ) <= $(vY)
							, RGB(255,151,3)
							, If
							(
								(
									Rangesum
									(
										Above
										(
											Aggr($(exp_Показатель), $(exp_Измерение)) 
											/ 
											Aggr($(exp_Показатель_total), $(exp_Измерение))
											, 0, RowNo()
										)
									)
								) 
								<= $(vB) 
								and $(exp_XYZ) <= $(vY)
								, RGB(255,234,31)
								, RGB(255,5,3)
							)
						)
					)
				)
			)
		)
	)
)
"
color_ColorMix;"
ColorMix1
(
	rank(total column(1))
	/
	noofrows(TOTAL),
	RGB(77,124,171), RGB(240,240,240)
)
"
color_PivotColor;"
If(dimensionality() = 3, Blue(10),
	If(dimensionality() = 2, Blue(40),
		If(dimensionality() = 1, Blue(70)
		)
	)	
)
"
func_MonthDiff;"
(
  (
    year
    (
      alt($2, today(2))
    )
    * 12
  ) 
  + 
  (
    month
    (
      alt($2, today(2))
    )
  )
)
- 
(
  (
    year($1)
    *
    12
  )
  +
  month($1)
)
"
exp_Измерение;"
[$(=only(%DimField))]
"
exp_Период;"
[$(=only(%DimPeriod))]
"
exp_Прогноз;"
$(=$(=only(%MesFieldПрогноз)))
"
exp_Показатель;"
$(=$(=only(%MesField)))
"
exp_Показатель_total;"
$(=$(=only(%MesFieldTotal)))
"
exp_Показатель2;"
$(=$(=only(%MesField2)))
"
exp_ПоказательYTY;"
$(=$(=only(%MesFieldYTY)))
"
exp_ПоказательНаРеализации;"
$(=$(=only(%MesFieldНаРеал)))
"
exp_BCG_Доля;"
(
	Aggr({[1period]+[2period]} $(exp_Показатель), $(exp_Измерение))
)
/
(
	Fabs
	(
		Aggr({[1period]+[2period]} $(exp_Показатель_total), $(exp_Измерение))
	)
)
"
exp_BCG_Рост;"
(
	Aggr({[2period]} $(exp_Показатель), $(exp_Измерение))
	-
	Aggr({[1period]} $(exp_Показатель), $(exp_Измерение))
)
/
Fabs
(
	Aggr({[2period]} $(exp_Показатель_total), $(exp_Измерение))
	-
	Aggr({[1period]} $(exp_Показатель_total), $(exp_Измерение))
)
"
exp_SetAnalysis;"
{<'&replace(replace(if(len(GetCurrentSelections ( '""},' , ' = {""' ,'"",""',1000,'SAF')&'""}')<=2,'','['&GetCurrentSelections ( '""},' , '= {""' ,'"",""',1000,'SAF')&'""}'),'=',']='),'},','},[')&'>}
"
exp_XYZ;"
RangeMax
(
  RangeMin
  (
    sterr
    (
    	Aggr
    	(
    		{<$(set_УсловияПродаж), [Продано единиц] = {"> 0"}>}
    		$(exp_Показатель)
    		, $(exp_Период), $(exp_Измерение)
    	)
    )
    /
    Avg
    (
    	Aggr
    	(
    		{<$(set_УсловияПродаж), [Продано единиц] = {"> 0"}>} 
    		$(exp_Показатель)
    		, $(exp_Период), $(exp_Измерение)
    	)
    )
    , 1.1
  )
  , -0.1
)
"
exp_АКБ;"
Count({<$(set_УсловияСреднийЧек)>} Distinct [Контрагент])
"
exp_АКБ_total;"
Sum
(
	total Aggr
	(
		Count({<$(set_УсловияСреднийЧек)>} Distinct [Контрагент])
		, $(exp_Измерение)
	)
)
"
exp_АКБPYTD;"
Count({<$(set_УсловияСреднийЧек), $(set_УсловияPYTD)>} Distinct [Контрагент])
"
exp_АКБYTD;"
Count({<$(set_УсловияСреднийЧек), $(set_УсловияYTD)>} Distinct [Контрагент])
"
exp_АКБYTY;"
Count({<$(set_УсловияСреднийЧек), $(set_УсловияYTY)>} Distinct [Контрагент])
"
exp_ВаловаяПрибыль;"
(
	Sum({<$(set_УсловияПродаж)>} Стоимость)
	+
	Sum({<$(set_УсловияПродаж)>} СуммаЗащиты)
)
-
(
	Sum
	(
		{<$(set_УсловияПродаж)>} 
		[Первая себестоимость]
		*
		[Продано единиц]
	)
)
"
exp_ВаловаяПрибыль_total;"
(
	Sum({<$(set_УсловияПродаж)>} total Стоимость)
	+
	Sum({<$(set_УсловияПродаж)>} total СуммаЗащиты)
)
-
(
	Sum
	(
		{<$(set_УсловияПродаж)>} 
		total [Продано единиц]
		*
		[Первая себестоимость]
	)
)
"
exp_ВаловаяПрибыльPYTD;"
(
	Sum({<$(set_УсловияПродаж), $(set_УсловияPYTD)>} Стоимость)
	+
	Sum({<$(set_УсловияПродаж), $(set_УсловияPYTD)>} СуммаЗащиты)
)
-
(
	Sum
	(
		{<$(set_УсловияПродаж), $(set_УсловияPYTD)>} 
		[Первая себестоимость] 
		* 
		[Продано единиц]
	)
)
"
exp_ВаловаяПрибыльYTD;"
(
	Sum({<$(set_УсловияПродаж), $(set_УсловияYTD)>} Стоимость)
	+
	Sum({<$(set_УсловияПродаж), $(set_УсловияYTD)>} СуммаЗащиты)
)
-
(
	Sum
	(
		{<$(set_УсловияПродаж), $(set_УсловияYTD)>} 
		[Первая себестоимость] 
		* 
		[Продано единиц]
	)
)
"
exp_ВаловаяПрибыльYTY;"
(
	Sum({<$(set_УсловияПродаж), $(set_УсловияYTY)>} Стоимость)
	+
	Sum({<$(set_УсловияПродаж), $(set_УсловияYTY)>} СуммаЗащиты)
)
-
(
	Sum
	(
		{<$(set_УсловияПродаж), $(set_УсловияYTY)>} 
		[Первая себестоимость] 
		* 
		[Продано единиц]
	)
)
"
exp_ВаловаяПрибыльПрогноз;"
(
	Sum
	(
		{<$(set_УсловияПродажПрогноз), _FlagCurrentDate={1}>} 
		Стоимость
	)
	+
	Sum
	(
		{<$(set_УсловияПродажПрогноз), _FlagCurrentDate={1}>} 
		СуммаЗащиты
	)
	+
	Sum
	(
		{<$(set_УсловияПродажПрогноз), _FlagCurrentDate={1}>} 
		[СуммаВозвратаНДС]
		*
		[Продано единиц]
	)
	-
	Sum
	(
		{<$(set_УсловияПродажПрогноз), _FlagCurrentDate={1}>} 
		ПроцентВложений
	)
)
-
(
	Sum
	(
		{<$(set_УсловияПродажПрогноз), _FlagCurrentDate={1}>} 
		[Первая себестоимость] 
		* 
		[Продано единиц]
	)
)
"
exp_ВаловаяПрибыльСУчетомВсего;"
(
	(
		Sum({<$(set_УсловияПродаж)>} Стоимость) 
		+ 
		Sum({<$(set_УсловияПродаж)>} СуммаЗащиты)
		+ 
		Sum
		(
			{<$(set_УсловияПродаж)>} 
			[СуммаВозвратаНДС]
			*
			[Продано единиц]
		) 
		- 
		Sum({<$(set_УсловияПродаж)>} ПроцентВложений)
	)
	-
	(
		Sum
		(
			{<$(set_УсловияПродаж)>} 
			[Первая себестоимость] 
			* 
			[Продано единиц]
		)
	)
)
"
exp_ВалПрибыльВПрошломГоду;"
(
  Sum({1 <$(set_УсловияПокПрГод)>} Стоимость) 
  + 
  Sum({1 <$(set_УсловияПокПрГод)>} СуммаЗащиты)
) 
- 
(
  Sum
  (
    {1 <$(set_УсловияПокПрГод)>} 
    [Первая себестоимость] 
    * 
    [Продано единиц]
  )
)
"
exp_ВалПрибыльВТекущемГоду;"
(
  Sum({1 <$(set_УсловияПокТекГод)>} Стоимость) 
  + 
  Sum({1 <$(set_УсловияПокТекГод)>} СуммаЗащиты)
) 
- 
(
  Sum
  (
    {1 <$(set_УсловияПокТекГод)>} 
    [Первая себестоимость] 
    * 
    [Продано единиц]
  )
)
"
exp_ВалПрибыльДляСравненияСоСкидками;"
(
  Sum
  (
    {<$(set_УсловияСравненияСоСкидками2)>} 
    Стоимость
  )
  +
  Sum
  (
    {<$(set_УсловияСравненияСоСкидками2)>} 
    СуммаЗащиты
  )
) 
- 
(
  Sum
  (
    {<$(set_УсловияСравненияСоСкидками2)>} 
    [Первая себестоимость] 
    * 
    [Продано единиц]
  )
)
"
exp_ВалПрибыльНаДатуОтгрузкиСУчетомВсего;"
(
  (
    (
      Sum
      (
        {<$(set_УсловияПродаж)>} 
        Стоимость 
        * 
        [КурсUSDпр] 
        / 
        [КурсUSDРеал]
      )
    ) 
    + 
    Sum({<$(set_УсловияПродаж)>} СуммаЗащиты)
    + 
    Sum
    (
      {<$(set_УсловияПродаж)>} 
      [СуммаВозвратаНДС]
      *
      [Продано единиц]
    )
    -
    Sum({<$(set_УсловияПродаж)>} $(exp_РасчетВложений))
  )
  -
  Sum
  (
    {<$(set_УсловияПродаж)>} 
    [Первая себестоимость] 
    * 
    [Продано единиц]
  )
)
"
exp_ВалПрибыльПоКомпании;"
(
  Sum
  (
    {<$(set_УсловияВаловаяПрибыльПоКомпании)>} 
    Стоимость
  )
  +
  Sum
  (
    {<$(set_УсловияВаловаяПрибыльПоКомпании)>} 
    СуммаЗащиты
  )
)
-
(
  Sum
  (
    {<$(set_УсловияВаловаяПрибыльПоКомпании)>} 
    [Первая себестоимость] 
    * 
    [Продано единиц]
  )
)
"
exp_ВозвратНДС;"
Sum([СуммаВозвратаНДС] * [Продано единиц])
"
exp_ВозвращеноПоРеал;"
Sum({<[ТоварНаРеализации] = {'Да'}>} [ВозвращеноПоРеализации])
+
Sum
(
  {<[ТоварНаРеализации] = {'Да'}, [Тип документа] = {'Возврат от покупателя'}>} 
  fAbs([Продано единиц])
)
"
exp_ВозвращеноПоРеалНаКонецМесяца;"
Sum(Aggr([НачальноеКоличество], %Регистратор, %СерияОстаткаРеализации, [МесяцГод]))
-
Sum({<FMEnd = {1}>} [ОстатокНаРеализации])
-
Sum({<$(set_УсловияПродаж), [ТоварНаРеализации] = {'Да'}>} [Продано единиц])
"
exp_ВозвращеноПоРеалСумма;"
Round
(
  Sum
  (
    Aggr
    (
      Sum({<[ТоварНаРеализации] = {'Да'}>} [ВозвращеноПоРеализации])
      , %Регистратор, [Номенклатура], [Характеристика]
    ) 
    * 
    Aggr
    (
      Avg(ЦенаНаРеализации)
      , %Регистратор, [Номенклатура], [Характеристика]
    )
    / 
    Aggr
    (
      Avg(КурсUSDРеализации)
      , %Регистратор, [Номенклатура], [Характеристика]
    )
  )
  +
  fAbs
  (
    Sum
    (
      {<[Тип документа] = {'Возврат от покупателя'}, [ТоварНаРеализации] = {'Да'}>} 
      [Стоимость]
    )
  )
  , 0.01
)
"
exp_ВПсЕдТовараВмесяц;"
(
  (
    (
      Sum({<$(set_УсловияПродаж)>} Стоимость)
      +
      Sum({<$(set_УсловияПродаж)>} СуммаЗащиты)
    )
    - 
    (
      Sum
      (
        {<$(set_УсловияПродаж)>} 
        [Первая себестоимость] 
        * 
        [Продано единиц]
      )
    )
  ) 
  / 
  (
    Sum({<$(set_УсловияПродаж)>} [Продано единиц])
  )
) 
*
(
  $(exp_ОборачиваемостьВмесяц_Раз)
)
"
exp_ВПсУчетомОборачиваемости;"
($(exp_ВаловаяПрибыльСУчетомВсего))
* 
($(exp_ОборачиваемостьВмесяц_Раз))
"
exp_Выручка;"
Sum({<$(set_УсловияПродаж)>} [СтоимостьСНДС])
"
exp_ВыручкаВТекущемГоду;"
Sum({<$(set_УсловияПокТекГод)>} [СтоимостьСНДС])
"
exp_Выручка_total;"
Sum({<$(set_УсловияПродаж)>} total [СтоимостьСНДС])
"
exp_ВыручкаPYTD;"
Sum({<$(set_УсловияПродаж), $(set_УсловияPYTD)>} [СтоимостьСНДС])
"
exp_ВыручкаYTY;"
Sum({<$(set_УсловияПродаж), $(set_УсловияYTY)>} [СтоимостьСНДС])
"
exp_ВыручкаБезСкидок;"
Sum({<$(set_УсловияПродаж)>} [СтоимостьБезСкидокСНДС])
"
exp_ВыручкаПрогноз;"
Sum({<$(set_УсловияПродажПрогноз), [_FlagCurrentDate] = {1}>} [СтоимостьСНДС])
"
exp_ГП;"
(
  Sum({<$(set_УсловияПродаж)>} Стоимость) 
  + 
  Sum({<$(set_УсловияПродаж)>} СуммаЗащиты) 
  + 
  Sum
  (
    {<$(set_УсловияПродаж)>} 
    [СуммаВозвратаНДС]
    *
    [Продано единиц]
  )
) 
- 
(
  Sum
  (
    {<$(set_УсловияПродаж)>} 
    [Первая себестоимость] 
    * 
    [Продано единиц]
  )
)
"
exp_ДебитНаКаждыйДень;"
Sum({<Собственные = {0}>} [ДолгУпр])
"
exp_ДебитНаКонецМесяца;"
Sum({<Собственные = {0}, FMEnd = {1}>} [ДолгУпр])
"
exp_ДебитНаКонецНедели;"
Sum({<Собственные = {0}, FWEnd = {1}>} [ДолгУпр])
"
exp_ДебитНаКонецНеделиВТекущемГоду;"
Sum({<set_УсловияПокТекГод, FWEnd = {1}>} [ДолгУпр])
"
exp_ДебитНаПоследДату;"
Sum({<Собственные = {0}, Дата = {""=rank(Дата, 4) = 1""}>} [ДолгУпр])
"
exp_ДнейНаРеализации;"
Max
(
  {<[ТоварНаРеализации] = {'Да'}>} 
  Aggr
  (
    {<[ТоварНаРеализации] = {'Да'}>} 
    RangeMax
    (
      (
        Today(0) 
        - 
        Max
        (
          {<[ТоварНаРеализации] = {'Да'}>} 
          Aggr
          (
            {<[ТоварНаРеализации] = {'Да'}>} 
            nodistinct %ДатаРеал
            , %Регистратор
          )
        )
      ) 
      *
      RangeMin
      (
        Sum
        (
          {<[ТоварНаРеализации] = {'Да'}, Дата = {""=rank({<[ТоварНаРеализации] = {'Да'}>} Дата, 4) = 1""}>} 
          [ОстатокНаРеализации]
        )
        , 1
      )
      , 
      (
        Max
        (
          {<[ТоварНаРеализации] = {'Да'}, $(set_УсловияПродаж), [Продано единиц] = {""> 0""}>} 
          Дата
        ) 
        - 
        %ДатаРеал
      )
      ,
      (
        Max
        (
          {<[ТоварНаРеализации] = {'Да'}, [ВозвращеноПоРеализации] = {""<> 0""}>} 
          Дата
        ) 
        - 
        %ДатаРеал
      )
    )
    , %Регистратор, [Номенклатура], [Контрагент], [Категория]
  )
)
"
exp_ДнейСПоследнейПродажи;"
Min
(
  Aggr
  (
    (
      Today(0) 
      - 
      Max
      (
        {<$(set_УсловияПродаж), [Продано единиц] = {""> 0""}, [ТоварНаРеализации] = {'Да'}>} 
        Дата
      )
    )
    , %Регистратор, [Номенклатура], [Контрагент], [Категория]
  )
)
*
RangeMin
(
  Sum
  (
    {<[ТоварНаРеализации] = {'Да'}, Дата = {""=rank(Дата, 4) = 1""}>} 
    [ОстатокНаРеализации]
  )
  , 1
)
"
exp_ДоляВалаГолКонтргент;"
(
	Rank($(exp_ВаловаяПрибыль),1)
	-
	1
)
/
Count({<$(set_УсловияПродаж)>} distinct total [Головной контрагент])
"
exp_ДоляВложенийОстатковОтСебестоимости;"
(
  Sum
  (
    Aggr
    (
      Sum
      (
        [СуммаПлатежаОстатка] 
        * 
        (
          [СтавкаПроцентаОстатка] 
          * 
          (
            Max(total [Дата]) 
            - 
            [ДатаПлатежаОстатка] 
            + 
            1
          ) 
          / 
          365
        )
      )
      *
      (
        Sum({<Дата = {""=rank(Дата, 4) = 1""}>} Остаток)
      )
      , Склад, %СерияОстатка, [ДатаПлатежаОстатка]
    )
  )
)
/
Sum
(
  {<Дата = {""=rank(Дата, 4) = 1""}>} 
  [ПерваяСебОстатка] 
  * 
  Остаток
)
"
exp_ДоляВозвратовПоРеализации;"
(
  Sum({<[ТоварНаРеализации] = {'Да'}>} [ВозвращеноПоРеализации])
  +
  Sum({<[ТоварНаРеализации] = {'Да'}, [Тип документа] = {'Возврат от покупателя'}>} fAbs([Продано единиц]))
)
/
Sum
(
  Aggr({<[ТоварНаРеализации] = {'Да'}>} distinct [НачальноеКоличество], %Регистратор, %СерияОстаткаРеализации)
)
"
exp_ДоляВыручГолКонтрагент;"
(
	Rank
	(
		Sum({<$(set_УсловияПродаж)>} СтоимостьСНДС),1
	)
	-
	1
)
/
Count({<$(set_УсловияПродаж)>} distinct total [Головной контрагент])
"
exp_ДоляЗПотГП_%;"
If
(
  $(exp_ВаловаяПрибыльСУчетомВсего) < 0
  , If
  (
    Sum([ЗП]) <> 0
    ,
    (
      Sum([ЗП]) 
      + 
      (
        $(exp_ВаловаяПрибыльСУчетомВсего) 
        * 
        -1
      )
    )
    , 0
  )
  ,
  Sum([ЗП]) 
  / 
  RangeMax(1, $(exp_ВаловаяПрибыльСУчетомВсего))
)
"
exp_ДоляКонтрагентов_%;"
Count({<$(set_УсловияПродаж)>} Distinct [Контрагент]) 
/ 
Aggr
(
  {<$(set_УсловияПродаж)>} 
  noDistinct Count({<$(set_УсловияПродаж)>} Distinct [Контрагент])
  , [Год]
)"
exp_ДоляНаценки;"
(
	Rank($(exp_Наценка),1)
	-
	1
)
/
Count({<$(set_УсловияПродаж)>} distinct total [Номенклатура])
"
exp_ДоляПоказатель1;"
Aggr
(
	(
		Rank($(exp_Показатель))
		-
		1
	)
	/
	Count({<$(set_УсловияПродаж)>} distinct total $(exp_Измерение))
	, $(exp_Измерение)
)
"
exp_ДоляПоказатель2;"
Aggr
(
	(
		Rank($(exp_Показатель2))
		-
		1
	)
	/
	Count({<$(set_УсловияПродаж)>} distinct total $(exp_Измерение))
	, $(exp_Измерение)
)
"
exp_ДоляПродажПоРеал;"
Sum({<$(set_УсловияПродаж), [ТоварНаРеализации] = {'Да'}>} [Продано единиц])
/
Sum
(
  Aggr({<[ТоварНаРеализации] = {'Да'}>} distinct [НачальноеКоличество], %Регистратор, %СерияОстаткаРеализации)
)
"
exp_ДоляРезервов;"
Sum({<$(set_Склады)>} [Резерв])
/
Sum({<$(set_Склады)>} Остаток)
"
exp_ДоляРентабельностиГолКонтрагент;"
(
	Rank($(exp_Наценка),1)
	-
	1
)
/
Count({<$(set_УсловияПродаж)>} distinct total [Головной контрагент])
"
exp_ДоходностьТЗгодовая;"
(
	$(exp_ВаловаяПрибыльСУчетомВсего)
  / 
	Count(distinct [МесяцГод])
)
/ 
($(exp_СреднийТЗвМесяц_себ))
* 
12
"
exp_ДоходностьТЗзаПериод;"
($(exp_ВаловаяПрибыльСУчетомВсего)) / ($(exp_СреднийТЗвМесяц_себ))
"
exp_ЗП;"
Sum([ЗП])
"
exp_Кол_во100%резервов;"
Count
(
  {<[СвободныйОстаток]={0}, [Склад] = {$(set_ОсновныеСклады), 'Производство'}>} 
  [СвободныйОстаток]
)
"
exp_Кол_воДнейСДатыПлатежа;"
If
(
  (
    Sum({<Дата = {""=rank(Дата, 4) = 1""}>} Остаток)
  ) 
  > 0
  , Max
  (
    Max(total [Дата]) 
    - 
    Aggr
    (
      Min({<Дата = {""=rank(Дата, 4) = 1""}>} [ДатаПлатежаОстатка])
      , Склад, %СерияОстатка, [ДатаПлатежаОстатка]
    ) 
    + 
    1
  )
)
"
exp_Кол_воКонтрагентов;"
Count({<$(set_УсловияПродаж)>} Distinct [Контрагент])
"
exp_Кол_воНоменклатуры;"
Count(Distinct [Номенклатура])
"
exp_Кол_воСделокДляСравненияСоСкидками;"
Count
(
  {<$(set_УсловияСравненияСоСкидками2)>} 
  Distinct [%Регистратор]
)
"
exp_КоличествоСделок;"
Count({<$(set_УсловияСреднийЧек)>} Distinct %Регистратор)
"
exp_КоличествоСделок_total;"
Count({<$(set_УсловияСреднийЧек)>} total Distinct %Регистратор)
"
exp_КоличествоСделок_Прошлый;"
Count({1 <$(set_УсловияСреднийЧек), FLY={1}>} Distinct %Регистратор)
"
exp_КоличествоСделок_Текущий;"
Count({1 <$(set_УсловияСреднийЧек), FCY={1}>} Distinct %Регистратор)
"
exp_КоличествоСделокPYTD;"
Count({<$(set_УсловияСреднийЧек), $(set_УсловияPYTD)>} Distinct %Регистратор)
"
exp_КоличествоСделокYTD;"
Count({<$(set_УсловияСреднийЧек), $(set_УсловияYTD)>} Distinct %Регистратор)
"
exp_КоличествоСделокYTY;"
Count({<$(set_УсловияСреднийЧек), $(set_УсловияYTY)>} Distinct %Регистратор)
"
exp_КоличествоСделокПрогноз;"
Count({<$(set_УсловияСреднийЧек), [_FlagCurrentDate]={1}>} Distinct %Регистратор)
"
exp_КолСделокПоИзмерению;"
Sum
(
	{<$(set_УсловияСреднийЧек)>} 
	Aggr
	(
		{<$(set_УсловияСреднийЧек)>} distinct
		Count({<$(set_УсловияСреднийЧек)>} Distinct %Регистратор)
		, [Месяц], $(exp_Измерение)
	)
)
"
exp_КолСделокПоИзмерению_total;"
Sum(
	{<$(set_УсловияСреднийЧек)>} total
	Aggr
	(
		{<$(set_УсловияСреднийЧек)>} distinct
		Count({<$(set_УсловияСреднийЧек)>} Distinct %Регистратор)
		, [Месяц], $(exp_Измерение)
	)
)
"
exp_КоэфСезК1месяцу;"
If
(
	RowNo() = 1
	, $(exp_КоэфСезонОчищ) / Bottom($(exp_КоэфСезонОчищ))
	, $(exp_КоэфСезонОчищ) / Above($(exp_КоэфСезонОчищ), 1)
)
"
exp_КоэфСезК2месяцам;"
If
(
	RowNo() = 1
	, $(exp_КоэфСезонОчищ) / RangeAvg(Bottom($(exp_КоэфСезонОчищ), 1, 2))
	, If
	(
		RowNo() = 2
		, 
		$(exp_КоэфСезонОчищ)
		/
		RangeAvg(Bottom($(exp_КоэфСезонОчищ)), Above($(exp_КоэфСезонОчищ), 1))
		, 
		$(exp_КоэфСезонОчищ)
		/ 
		RangeAvg(Above($(exp_КоэфСезонОчищ), 1, 2))
	)
)
"
exp_КоэфСезК3месяцам;"
If
(
	RowNo() = 1
	,
	$(exp_КоэфСезонОчищ) 
	/ 
	RangeAvg(Bottom($(exp_КоэфСезонОчищ), 1, 3))
	,
	If
	(
		RowNo() = 2
		,
		$(exp_КоэфСезонОчищ) 
		/ 
		RangeAvg(Bottom($(exp_КоэфСезонОчищ), 1, 2), Above($(exp_КоэфСезонОчищ), 1))
		,
		If
		(
			RowNo() = 3
			,
			$(exp_КоэфСезонОчищ) 
			/ 
			RangeAvg(Bottom($(exp_КоэфСезонОчищ)), Above($(exp_КоэфСезонОчищ), 1, 2))
			,
			$(exp_КоэфСезонОчищ) 
			/ 
			RangeAvg(Above($(exp_КоэфСезонОчищ), 1, 3))
		)
	)
)
"
exp_КоэфСезК4месяцам;"
If
(
	RowNo() = 1
	,
	$(exp_КоэфСезонОчищ) 
	/ 
	RangeAvg(Bottom($(exp_КоэфСезонОчищ), 1, 4))
	,
	If
	(
		RowNo() = 2
		,
		$(exp_КоэфСезонОчищ) 
		/ 
		RangeAvg(Bottom($(exp_КоэфСезонОчищ), 1, 3), Above($(exp_КоэфСезонОчищ), 1))
		,
		If
		(
			RowNo() = 3
			,
			$(exp_КоэфСезонОчищ) 
			/ 
			RangeAvg(Bottom($(exp_КоэфСезонОчищ), 1, 2), Above($(exp_КоэфСезонОчищ), 1, 2))
			,
			If
			(
				RowNo() = 4
				,
				$(exp_КоэфСезонОчищ) 
				/ 
				RangeAvg(Bottom($(exp_КоэфСезонОчищ)), Above($(exp_КоэфСезонОчищ), 1, 3))
				,
				$(exp_КоэфСезонОчищ) 
				/ 
				RangeAvg(Above($(exp_КоэфСезонОчищ), 1, 4))
        	)
		)
	)
)
"
exp_КоэфСезонОчищ;"
Aggr
(
	nodistinct 
	Avg
	(
		aggr($(exp_Прогноз), [ДатаПрогноза.Прогноз.МесяцГодПрогноза]) 
		/ 
		aggr($(exp_ЛинТрендПоказателя), [ДатаПрогноза.Прогноз.МесяцГодПрогноза])
	), [ДатаПрогноза.Прогноз.Месяц]
)
/
Avg
(
	total Aggr
	(
		Avg
		(
			aggr($(exp_Прогноз), [ДатаПрогноза.Прогноз.МесяцГодПрогноза]) 
			/ 
			aggr($(exp_ЛинТрендПоказателя), [ДатаПрогноза.Прогноз.МесяцГодПрогноза])
		), [ДатаПрогноза.Прогноз.Месяц]
	)
)
"
exp_КоэфСезонОчищ_Вариант2;"
Aggr
({<Год =>} 
	nodistinct 
	Avg
	({<Год =>} 
		aggr({<Год =>} $(exp_Прогноз), [ДатаПрогноза.Прогноз.МесяцГодПрогноза]) 
		/ 
		aggr({<Год =>} $(exp_ЛинТрендПоказателя), [ДатаПрогноза.Прогноз.МесяцГодПрогноза])
	), [ДатаПрогноза.Прогноз.Месяц]
)
/
Avg
({<Год =>} 
	total Aggr
	({<Год =>} 
		Avg
		({<Год =>} 
			aggr({<Год =>} $(exp_Прогноз), [ДатаПрогноза.Прогноз.МесяцГодПрогноза]) 
			/ 
			aggr({<Год =>} $(exp_ЛинТрендПоказателя), [ДатаПрогноза.Прогноз.МесяцГодПрогноза])
		), [ДатаПрогноза.Прогноз.Месяц]
	)
)
"
exp_кТРО;"
Sum
(
  {<[Собственные] = {0}, [%ВидПродажи] =- {3}, [Контрагент] =- {'ИМ'}, [Ответственный] -= {'Карпович_Андрей'}, $(set_Склады)>} 
  [Продано единиц]
)
/ 
RangeMax
(
  Sum
  (
    {<[Собственные] = {0}, [Контрагент] =- {'ИМ'}, [Ответственный] -= {'Карпович_Андрей'}, $(set_Склады)>} 
    [Заказано] 
    * 
    [F_Врезерве]
  )
  , 1
)
"
exp_ЛинТрендВалПрибыли;"
linest_m
(
	TOTAL aggr
	(
		if($(exp_ВаловаяПрибыль), $(exp_ВаловаяПрибыль))
		,[МесяцГод]
	)
	,[МесяцГод]
)
*
only({1} [МесяцГод])
+
linest_b
(
	TOTAL aggr
	(
		if($(exp_ВаловаяПрибыль), $(exp_ВаловаяПрибыль))
		,[МесяцГод]
	),[МесяцГод]
)
"
exp_ЛинТрендПоказателя;"
linest_m
(
	TOTAL aggr
	(
		If($(exp_Прогноз), $(exp_Прогноз))
		,[ДатаПрогноза.Прогноз.МесяцГодПрогноза]
	)
	,[ДатаПрогноза.Прогноз.МесяцГодПрогноза]
)
*
only({1} [ДатаПрогноза.Прогноз.МесяцГодПрогноза])
+
linest_b
(
	TOTAL aggr
	(
		If($(exp_Прогноз), $(exp_Прогноз))
		,[ДатаПрогноза.Прогноз.МесяцГодПрогноза]
	)
	,[ДатаПрогноза.Прогноз.МесяцГодПрогноза]
)
"
exp_МаксПросрочка;"
Max({<Собственные = {0}, ДолгУпр = {""> 1""}>} Просрочка)
"
exp_МинРентТекГод;"
Aggr
(
	{1 <set_УсловияМинРентТекГод>}
		(
			(Sum(Стоимость)+Sum(СуммаЗащиты))
			/
			(
				Sum
				(
					[Первая себестоимость]
					*
					[Продано единиц]
				)
			)
			-
			1
		)
, Дата
, Номенклатура
)
"
exp_Наценка;"
(
	(
		Sum({<$(set_УсловияПродаж)>} Стоимость)
		+
		Sum({<$(set_УсловияПродаж)>} СуммаЗащиты)
	)
	-
	Sum
	(
		{<$(set_УсловияПродаж)>} 
		[Первая себестоимость] 
		* 
		[Продано единиц]
	)
)
/
Fabs
(
	Sum
	(
		{<$(set_УсловияПродаж)>} 
		[Первая себестоимость] 
		* 
		[Продано единиц]
	)
)
"
exp_НаценкаБезВложений;"
(
  (
    Sum({<$(set_УсловияПродаж)>} Стоимость) 
    + 
    Sum({<$(set_УсловияПродаж)>} СуммаЗащиты)
    +
    Sum
    (
      {<$(set_УсловияПродаж)>} 
      [СуммаВозвратаНДС]
      *
      [Продано единиц]
    )
  )
  -
  Sum
  (
    {<$(set_УсловияПродаж)>} 
    [Первая себестоимость] 
    * 
    [Продано единиц]
  )
)
/
Fabs
(
  Sum
  (
    {<$(set_УсловияПродаж)>} 
    [Первая себестоимость] 
    * 
    [Продано единиц]
  )
)
"
exp_НаценкаБезНичего;"
(
  Sum({<$(set_УсловияПродаж)>} Стоимость)
  -
  Sum
  (
    {<$(set_УсловияПродаж)>} 
    [Первая себестоимость] 
    * 
    [Продано единиц]
  )
)
/
Fabs
(
  Sum
  (
    {<$(set_УсловияПродаж)>} 
    [Первая себестоимость] 
    * 
    [Продано единиц]
  )
)
"
exp_НаценкаВПрошломГоду;"
(
  (
    Sum({1 <$(set_УсловияПокПрГод)>} Стоимость)
    +
    Sum({1 <$(set_УсловияПокПрГод)>} СуммаЗащиты)
  )
  -
  Sum
  (
    {1 <$(set_УсловияПокПрГод)>} 
    [Первая себестоимость] 
    * 
    [Продано единиц]
  )
)
/
Fabs
(
  Sum
  (
    {1 <$(set_УсловияПокПрГод)>} 
    [Первая себестоимость] 
    * 
    [Продано единиц]
  )
)
"
exp_НаценкаВТекущемГоду;"
(
  (
    Sum({1 <$(set_УсловияПокТекГод)>} Стоимость)
    +
    Sum({1 <$(set_УсловияПокТекГод)>} СуммаЗащиты)
  )
  -
  Sum
  (
    {1 <$(set_УсловияПокТекГод)>} 
    [Первая себестоимость] 
    * 
    [Продано единиц]
  )
)
/
Fabs
(
  Sum
  (
    {1 <$(set_УсловияПокТекГод)>} 
    [Первая себестоимость] 
    * 
    [Продано единиц]
  )
)
"
exp_НаценкаДляСравненияСоСкидками;"
(
  (
    Sum
    (
      {<$(set_УсловияСравненияСоСкидками2)>} 
      Стоимость
    )
    +
    Sum
    (
      {<$(set_УсловияСравненияСоСкидками2)>} 
      СуммаЗащиты
    )
  )
  -
  Sum
  (
    {<$(set_УсловияСравненияСоСкидками2)>} 
    [Первая себестоимость] 
    * 
    [Продано единиц]
  )
)
/
Fabs
(
  Sum
  (
    {<$(set_УсловияСравненияСоСкидками2)>} 
    [Первая себестоимость] 
    * 
    [Продано единиц]
  )
)
"
exp_НаценкаОстатковНаПоследДатуПоТекущей6Х_%;"
(
  (
    Sum
    (
      Aggr
      (
        Sum
        (
          {<Дата = {""=rank(Дата, 4) = 1""}>} 
          Остаток 
          * 
          [6X]
        )
        , %СерияОстатка, [Номенклатура], [Категория]
      )
    )
    /
    Only(total {<Дата = {""=rank(Дата, 4) = 1""}>} [КурсUSD])
  )
  +
  Sum
  (
    Aggr
    (
      Sum({<$(set_УсловияПродаж)>} СуммаЗащиты)
      , %СерияОстатка, [Номенклатура], [Категория]
    )
  )
  +
  Sum
  (
    Aggr
    (
      Sum
      (
        {<$(set_УсловияПродаж)>} 
        [СуммаВозвратаНДС]
        *
        [Продано единиц]
      )
      , %СерияОстатка, [Номенклатура], [Категория]
    )
  )
  -
  Sum
  (
    Aggr
    (
      Sum
      (
        {<Дата = {""=rank(Дата, 4) = 1""}>} 
        Остаток 
        * 
        [ПерваяСебОстатка]
      )
      , %СерияОстатка, [Номенклатура], Категория
    )
  )
)
/
Sum
(
  Aggr
  (
    Sum
    (
      {<Дата = {""=rank(Дата, 4) = 1""}>} 
      Остаток 
      * 
      [ПерваяСебОстатка]
    )
    , %СерияОстатка, [Номенклатура], Категория
  )
)
"
exp_НаценкаОстатковНаПоследДатуПоТекущей6Х_%_1;"
(
  (
    Sum
    (
      Aggr
      (
        Sum
        (
          {<Дата = {""=rank(Дата, 4) = 1""}>} 
          Остаток 
          * 
          [6X]
        )
        , [Номенклатура]
      )
    )
    /
    Only(total {<Дата = {""=rank(Дата, 4) = 1""}>} [КурсUSD])
  )
  +
  Sum
  (
    Aggr
    (
      Sum({<$(set_УсловияПродаж)>} СуммаЗащиты)
      , [Номенклатура]
    )
  )
  +
  Sum
  (
    Aggr
    (
      Sum
      (
        {<$(set_УсловияПродаж)>} 
        [СуммаВозвратаНДС]
        *
        [Продано единиц]
      )
      , [Номенклатура]
    )
  )
  -
  Sum
  (
    Aggr
    (
      Sum
      (
        {<Дата = {""=rank(Дата, 4) = 1""}>} 
        Остаток 
        * 
        [ПерваяСебОстатка]
      )
      , [Номенклатура]
    )
  )
)
/
Sum
(
  Aggr
  (
    Sum
    (
      {<Дата = {""=rank(Дата, 4) = 1""}>} 
      Остаток 
      * 
      [ПерваяСебОстатка]
    )
    , [Номенклатура]
  )
)
"
exp_НаценкаСУчетомВсего;"
(
	(
		Sum({<$(set_УсловияПродаж)>} Стоимость) 
		+ 
		Sum({<$(set_УсловияПродаж)>} СуммаЗащиты)
		+
		Sum
		(
			{<$(set_УсловияПродаж)>} [СуммаВозвратаНДС]
			*
			[Продано единиц]
		) 
		- 
		Sum({<$(set_УсловияПродаж)>} ПроцентВложений)
	)
	-
	Sum
	(
		{<$(set_УсловияПродаж)>} 
		[Первая себестоимость] 
		* 
		[Продано единиц]
	)
)
/
Fabs
(
	Sum
	(
		{<$(set_УсловияПродаж)>} 
		[Первая себестоимость] 
		* 
		[Продано единиц]
	)
)
"
exp_НаценкаРеалСУчетомВсего;"
(
  (
    (
      Sum
      (
        {<$(set_УсловияПродаж)>} 
        Стоимость 
        * 
        [КурсUSDпр] 
        / 
        [КурсUSDРеал]
      )
    ) 
    + 
    Sum({<$(set_УсловияПродаж)>} СуммаЗащиты)
    +
    Sum
    (
      {<$(set_УсловияПродаж)>} 
      [СуммаВозвратаНДС]
      *
      [Продано единиц]
    )
    -
    Sum({<$(set_УсловияПродаж)>} $(exp_РасчетВложений))
  )
  -
  Sum
  (
    {<$(set_УсловияПродаж)>} 
    [Первая себестоимость] 
    * 
    [Продано единиц]
  )
)
/
Fabs
(
  Sum
  (
    {<$(set_УсловияПродаж)>} 
    [Первая себестоимость] 
    * 
    [Продано единиц]
  )
)
"
exp_НаценкаТЗсУчетомОборачиваемости;"
($(exp_ОборачиваемостьВмесяц_Раз)) * ($(exp_НаценкаСУчетомВсего))
"
exp_НачальноеКол_воТовараНаРеал;"
Sum
(
  Aggr
  (
    {<[ТоварНаРеализации]={'Да'}, [СохраняемОстаток] = {1}>} 
    distinct [НачальноеКоличество], %Регистратор, %Номенклатура, %СерияОстаткаРеализации
  )
)
"
exp_ОборачиваемостьВДнях_шт;"
Floor
(
  ($(exp_СреднийТЗвМесяц_Шт))
  * 
  (
    Max(total Дата) - Min(total Дата)
  ) 
  / 
  Sum([Продано единиц])
)
"
exp_ОборачиваемостьВдняхТекущийГод;"
$(exp_СреднийЗапасТекущий)
*
Count
(
  {<Номенклатура=, Категория=, Склад=, Бренд=, FCY ={1}, Год=, Месяц=, Организация = {$(set_ОсновныеОрганизации)}>} 
  [Дата]
)
/
Sum
(
  {<Номенклатура=, Категория=, Склад=, Бренд=, FCY ={1}, Год=, Месяц=, Организация = {$(set_ОсновныеОрганизации)}>} 
  [Продано единиц]
)
"
exp_ОборачиваемостьВмесяц_Раз;"
Floor
(
  30
  /
  (
    Floor
    (
      ($(exp_СреднийТЗвМесяц_Шт))
      * 
      (
        Max(total Дата) - Min(total Дата)
      ) 
      / 
      Sum([Продано единиц])
    )
  )
  , 0.01
)
"
exp_ОстаткиСУчетомСкладов_Шт;"
Sum({<$(set_Склады)>} [Остаток])
"
exp_ОстаткиПоТекущемуГоду_Шт;"
Sum({<$(set_ПокОстТекГод)>} [Остаток])
"
exp_Остаток_Шт;"
Sum([Остаток])
"
exp_ОстатокНаКонецМесяца_Шт;"
Sum({<FMEnd = {1}>} Остаток)
"
exp_ОстатокНаКонецПериода_Шт_1;"
Sum(RangeMax(FDEnd, FMEnd, FYEnd) * Остаток)
"
exp_ОстатокНаКонецПериода_Шт;"
Sum
(
  RangeMax(FMEnd, FYEnd) 
  * 
  Остаток
)
"
exp_ОстатокНаНачалоМесяца_Шт;"
Sum({<FMStart = {1}>} Остаток)
"
exp_ОстатокНаНачалоПериода_Шт;"
If
(
  GetSelectedCount(Дата) >= 1
  , Sum([Остаток])
  , If
  (
    GetSelectedCount([Месяц]) = 1
    , Sum
    (
      Aggr
      (
        FirstSortedValue(Distinct [Остаток], Дата)
        , Номенклатура, Склад, Дата
      )
    )
    , If
    (
      GetSelectedCount([Год]) = 1, Sum(FMStart * Остаток)
      , Sum(FYStart * Остаток)
    )
  )
)
"
exp_ОстатокНаПоследДату_Шт;"
Sum({<Дата = {""=rank(Дата, 4) = 1""}>} Остаток)
"
exp_ОстатокНаПоследДатуВТекущемГоду_Шт;"
Sum({<Дата = {""=rank(Дата, 4) = 1""}, $(set_ПокОстТекГод)>} Остаток)
"
exp_ОстатокНаПоследнююДату_Шт_1;"
Aggr
(
  Sum({<Дата = {""=rank(Дата, 4) = 1""}>} Остаток)
  , [Склад], [Категория], [Номенклатура], %СерияОстатка
)
"
exp_ОстатокНаРеалНаКонецМесяца_Шт;"
Sum({<FMEnd = {1}>} [ОстатокНаРеализации])
"
exp_ОстатокНаРеалНаПервуюДату_Шт;"
RangeMax
(
  Sum({<[ТоварНаРеализации] = {'Да'}, Дата = {""=rank(Дата, 4) = 1""}>} [ОстатокНаРеализации])
  +
  (
    Sum({<[ТоварНаРеализации] = {'Да'}>} [ВозвращеноПоРеализации]) 
    + 
    Sum
    (
      {<[ТоварНаРеализации] = {'Да'}, [Тип документа] = {'Возврат от покупателя'}>} 
      fAbs([Продано единиц])
    )
  )
  +
  Sum({<$(set_УсловияПродаж), [ТоварНаРеализации] = {'Да'}>} [Продано единиц])
  -
  Sum({<[ТоварНаРеализации] = {'Да'}, [СохраняемОстаток] = {1}>} [ПриходНаРеализацию])
  , 0
)
"
exp_ОстатокНаРеалНаПоследДату_Шт;"
Sum({<[ТоварНаРеализации] = {'Да'}, Дата = {""=rank(Дата, 4) = 1""}>} [ОстатокНаРеализации])
"
exp_ОтданоНаРеализацию_Шт;"
Sum
(
  Aggr({<[ТоварНаРеализации]={'Да'}>} [ОтданоНаРеализацию], %Регистратор, %Номенклатура, %Характеристика)
)

//Вместо ОтданоНаРеализацию можно использовтаь ПриходНаРеализацию с отбором Сохранять остаток = 1
"
exp_ОтданоНаРеалСтоимость;"
Round
(
  Sum
  (
    Aggr({<[ТоварНаРеализации] = {'Да'}, [СохраняемОстаток] = {1}>} distinct [НачальноеКоличество], %Регистратор, %СерияОстаткаРеализации)
  ) 
  *
  Aggr
  (
    ЦенаНаРеализации 
    / 
    КурсUSDРеализации
    , %Регистратор, %СерияОстаткаРеализации
  )
  , 0.01
)
"
exp_ПерваяСеб_USD;"
Sum({<$(set_УсловияПродаж)>} [Первая себестоимость] * [Продано единиц])
"
exp_ПопулярностьУКонтрагентов;"
Count(
  Aggr(Distinct [Контрагент], [Категория], [Номенклатура])
)
"
exp_пОСО_дни;"
Count({<[СвободныйОстаток]={0}, Остаток={""> 0""}, [Ответственный] -= {'Карпович_Андрей'}, $(set_Склады)>} distinct [Дата])
"
exp_пОСО_раз;"
Count({<[СвободныйОстаток]={0}, Остаток={""> 0""}, [Ответственный] -= {'Карпович_Андрей'}, $(set_Склады)>} distinct %Заказ)
"
exp_Приход;"
Sum([Приход])
"
exp_ПрогнозОптимистичный;"
Aggr
(
  If
  (
    [ДатаПрогноза.Прогноз.МесяцГодПрогноза] >=  MonthName(Today(1))
    , 
    Aggr($(exp_ЛинТрендПоказателя), [ДатаПрогноза.Прогноз.МесяцГодПрогноза]) 
    * 
    Aggr($(exp_КоэфСезонОчищ), [ДатаПрогноза.Прогноз.МесяцГодПрогноза])
  )
  +
  $(exp_Сигма3)
  , [ДатаПрогноза.Прогноз.МесяцГодПрогноза]
)
"
exp_ПрогнозПессимистичный;"
If
(
  [ДатаПрогноза.Прогноз.МесяцГодПрогноза] >=  MonthName(Today(1))
  ,
  Aggr($(exp_ЛинТрендПоказателя), [ДатаПрогноза.Прогноз.МесяцГодПрогноза]) 
  * 
  Aggr($(exp_КоэфСезонОчищ), [ДатаПрогноза.Прогноз.МесяцГодПрогноза])
)
-
$(exp_Сигма3)
"
exp_ПрогнозПоказатель;"
If($(exp_Прогноз), $(exp_Прогноз))
"
exp_ПрогнозСредний;"
If
(
  [ДатаПрогноза.Прогноз.МесяцГодПрогноза] >=  MonthName(Today(1))
  ,
  Aggr($(exp_ЛинТрендПоказателя), [ДатаПрогноза.Прогноз.МесяцГодПрогноза]) 
  * 
  Aggr($(exp_КоэфСезонОчищ), [ДатаПрогноза.Прогноз.МесяцГодПрогноза])
)
"
exp_Продажи_Шт;"
Sum({<[%ВидПродажи] =- {3}, [Контрагент] -= {'ИМ'}, [Ответственный] -= {'Карпович_Андрей'}, $(set_Склады)>} [Продано единиц])
"
exp_ПродажиНаПоследДату_Шт;"
Sum({<Дата = {""=rank(Дата, 4) = 1""}, $(set_УсловияПродаж)>} [Продано единиц])
"
exp_ПроданоЕдиниц;"
Sum({<$(set_УсловияПродаж)>} [Продано единиц])
"
exp_ПроданоЕдиниц_total;"
Sum({<$(set_УсловияПродаж)>} total [Продано единиц])
"
exp_ПроданоЕдиницYTY;"
Sum({<$(set_УсловияПродаж), $(set_УсловияYTY)>} [Продано единиц])
"
exp_ПроданоЕдиницПрогноз;"
Sum({<$(set_УсловияПродажПрогноз), [_FlagCurrentDate] = {1}>} [Продано единиц])
"
exp_ПроданоСопутствующегоТовара_Шт;"
Sum({<$(set_УсловияПродаж), [Сопутствующие товары] = E([Номенклатура])>} [Продано единиц])
"
exp_ПроданоШтукПоРеализации;"
Sum({<$(set_УсловияПродаж), [ТоварНаРеализации] = {'Да'}>} [Продано единиц])
"
exp_ПросрДебитНаКаждыйДень;"
Sum({<Собственные = {0}, [ПДЛГ]={1}>} [ДолгУпр])
"
exp_ПросрДебитНаКонецМесяца;"
Sum({<Собственные = {0}, [ПДЛГ]={1}, FMEnd = {1}>} [ДолгУпр])
"
exp_ПросрДебитНаКонецНедели;"
Sum({<Собственные = {0}, [ПДЛГ]={1}, FWEnd = {1}>} [ДолгУпр])
"
exp_ПросрДебитНаКонецНеделиВТекущемГоду;"
Sum({<set_УсловияПокТекГод, [ПДЛГ]={1}, FWEnd = {1}>} [ДолгУпр])
"
exp_ПросрДебНаПоследДату;"
Sum({<Собственные = {0}, [ПДЛГ]={1}, Дата = {""=rank(Дата, 4) = 1""}>} [ДолгУпр])
"
exp_Расход;"
Sum([Расход])
"
exp_РасчетВложений;"
(
	(
		[СуммаПлатежа] 
		* 
		(
			[СтавкаПроцента] 
			* 
			(
				Aggr(nodistinct %ДатаРеал, %Регистратор, %Серия, Склад, ДатаПлатежа) 
				- 
				[ДатаПлатежа] 
				+ 
				1
			) 
			/ 
			365
		)
	) 
	* 
	[Продано единиц]
)
"
exp_РеализованоШтук;"
Sum({<$(set_УсловияСреднийЧек)>} [Продано единиц])
"
exp_Резерв_Раз;"
Count
(
  {<[Собственные] = {0}, $(set_Склады)>} 
  Distinct %Заказ
)
"
exp_Резерв_Шт;"
Sum
(
  {<[Собственные] = {0}, $(set_Склады)>} 
  [Заказано] 
  * 
  [F_Врезерве]
)
"
exp_РезервНаКонецДня;"
Sum({<$(set_Склады)>} [Резерв])
"
exp_РезервНаКонецПериода;"
Sum(RangeMax(FMEnd, FYEnd) * [Резерв])
"
exp_Рентабельность;"
(
  Sum({<$(set_УсловияПродаж)>} Стоимость)
  +
  Sum({<$(set_УсловияПродаж)>} СуммаЗащиты)
  -
  (
    Sum
    (
      {<$(set_УсловияПродаж)>} 
      [Первая себестоимость] 
      * 
      [Продано единиц]
    )
  )
)
/
Fabs
(
  Sum({<$(set_УсловияПродаж)>} Стоимость)
  +
  Sum({<$(set_УсловияПродаж)>} СуммаЗащиты)
)
"
exp_РентабельностьPYTD;"
(
  Sum({<$(set_УсловияПродаж), $(set_УсловияPYTD)>} Стоимость)
  +
  Sum({<$(set_УсловияПродаж), $(set_УсловияPYTD)>} СуммаЗащиты)
  -
  (
    Sum
    (
      {<$(set_УсловияПродаж), $(set_УсловияPYTD)>} 
      [Первая себестоимость] 
      * 
      [Продано единиц]
    )
  )
)
/
Fabs
(
  Sum({<$(set_УсловияПродаж), $(set_УсловияPYTD)>} Стоимость)
  +
  Sum({<$(set_УсловияПродаж), $(set_УсловияPYTD)>} СуммаЗащиты)
)
"
exp_РентабельностьYTD;"
(
  Sum({<$(set_УсловияПродаж), $(set_УсловияYTD)>} Стоимость)
  +
  Sum({<$(set_УсловияПродаж), $(set_УсловияYTD)>} СуммаЗащиты)
  -
  (
    Sum
    (
      {<$(set_УсловияПродаж), $(set_УсловияYTD)>} 
      [Первая себестоимость] 
      * 
      [Продано единиц]
    )
  )
)
/
Fabs
(
  Sum({<$(set_УсловияПродаж), $(set_УсловияYTD)>} Стоимость)
  +
  Sum({<$(set_УсловияПродаж), $(set_УсловияYTD)>} СуммаЗащиты)
)
"
exp_РентабельностьВПрошломГоду;"
(
  Sum({<$(set_УсловияПокПрГод)>} Стоимость)
  +
  Sum({<$(set_УсловияПокПрГод)>} СуммаЗащиты)
  -
  (
    Sum
    (
      {<$(set_УсловияПокПрГод)>} 
      [Первая себестоимость] 
      * 
      [Продано единиц]
    )
  )
)
/
Fabs
(
  Sum({<$(set_УсловияПокПрГод)>} Стоимость)
  +
  Sum({<$(set_УсловияПокПрГод)>} СуммаЗащиты)
)
"
exp_РентабельностьВТекущемГоду;"
(
  Sum({<$(set_УсловияПокТекГод)>} Стоимость)
  +
  Sum({<$(set_УсловияПокТекГод)>} СуммаЗащиты)
  -
  (
    Sum
    (
      {<$(set_УсловияПокТекГод)>} 
      [Первая себестоимость] 
      * 
      [Продано единиц]
    )
  )
)
/
Fabs
(
  Sum({<$(set_УсловияПокТекГод)>} Стоимость)
  +
  Sum({<$(set_УсловияПокТекГод)>} СуммаЗащиты)
)
"
exp_РентРеалСУчетомВсего;"
(
  (
    (
      Sum({<$(set_УсловияПродаж)>} Стоимость) 
      * 
      (
        Sum([КурсUSDпр]) 
        / 
        Sum([КурсUSDРеал])
      )
    ) 
    + 
    Sum({<$(set_УсловияПродаж)>} СуммаЗащиты)
    +
    Sum
    (
      {<$(set_УсловияПродаж)>} 
      [СуммаВозвратаНДС]
      *
      [Продано единиц]
    ) 
    - 
    Sum({<$(set_УсловияПродаж)>} $(exp_РасчетВложений))
  )
  -
  (
    Sum
    (
      {<$(set_УсловияПродаж)>} 
      [Первая себестоимость] 
      * 
      [Продано единиц]
    )
  )
)
/
Fabs
(
  (
    Sum({<$(set_УсловияПродаж)>} Стоимость) 
    * 
    (
      Sum([КурсUSDпр]) 
      / 
      Sum([КурсUSDРеал])
    )
  ) 
  + 
  Sum({<$(set_УсловияПродаж)>} СуммаЗащиты)
  +
  Sum
  (
    {<$(set_УсловияПродаж)>} 
    [СуммаВозвратаНДС]
    *
    [Продано единиц]
  ) 
  - 
  Sum({<$(set_УсловияПродаж)>} $(exp_РасчетВложений))
)
"
exp_РентСУчетомВсего;"
(
  (
    Sum({<$(set_УсловияПродаж)>} Стоимость)
    +
    Sum({<$(set_УсловияПродаж)>} СуммаЗащиты)
    +
    Sum
    (
      {<$(set_УсловияПродаж)>} 
      [СуммаВозвратаНДС]
      *
      [Продано единиц]
    ) 
    - 
    Sum({<$(set_УсловияПродаж)>} ПроцентВложений)
  )
  -
  (
    Sum
    (
      {<$(set_УсловияПродаж)>} 
      [Первая себестоимость] 
      * 
      [Продано единиц]
    )
  )
)
/
Fabs
(
  Sum({<$(set_УсловияПродаж)>} Стоимость)
  +
  Sum({<$(set_УсловияПродаж)>} СуммаЗащиты)
  +
  Sum
  (
    {<$(set_УсловияПродаж)>} 
    [СуммаВозвратаНДС]
    *
    [Продано единиц]
  ) 
  - 
  Sum({<$(set_УсловияПродаж)>} ПроцентВложений)
)
"
exp_СвободныйОстаток;"
Sum
(
  {<[Ответственный] -= {'Карпович_Андрей'},[Склад] = {$(set_ОсновныеСклады), 'Производство'}>} 
  [Остаток]
)
- 
Fabs
(
  Sum
  (
    {<[Ответственный] -= {'Карпович_Андрей'},[Склад] = {$(set_ОсновныеСклады), 'Производство'}>} 
    [Резерв]
  )
)
"
exp_Себ_1_Остатков;"
Sum([ПерваяСебОстатка] * [Остаток])
"
exp_Себ_1_ОстатковНаКонецМесяца;"
Sum({<FMEnd = {1}>} [ПерваяСебОстатка] * [Остаток])
"
exp_Себ_1_ОстатковНаНачалоМесяца;"
Sum({<FMStart = {1}>} [ПерваяСебОстатка] * [Остаток])
"
exp_Себ_1_ОстатковНаПоследДату;"
Sum({<Дата = {""=rank(Дата, 4) = 1""}>} [ПерваяСебОстатка] * [Остаток])
"
exp_Себ_1_ОстатковНаПоследДату_%;"
Sum
(
  {<Дата = {""=rank(Дата, 4) = 1""}>} 
  [ПерваяСебОстатка] 
  * 
  [Остаток]
)
/
Sum
(
  total {<Дата = {""=rank(Дата, 4) = 1""}>} 
  [ПерваяСебОстатка] 
  * 
  [Остаток]
)
"
exp_Себ_1_ОстатковНаПоследнююДатуВТекущемГоду;"
Sum
(
  {1 <Дата = {""=rank(Total Дата, 4) = 1""}>} 
  Total 
  [ПерваяСебОстатка] 
  * 
  [Остаток]
)
"
exp_Сигма3;"
(
	sqrt
	(
		Aggr
		(
			nodistinct Sum
			(
				sqr
				(
					Aggr($(exp_Прогноз), [ДатаПрогноза.Прогноз.МесяцГодПрогноза])
					-
					(
						Aggr($(exp_ЛинТрендПоказателя), [ДатаПрогноза.Прогноз.МесяцГодПрогноза]) 
						* 
						Aggr($(exp_КоэфСезонОчищ), [ДатаПрогноза.Прогноз.МесяцГодПрогноза])
					)
				)
			)
			, [ДатаПрогноза.Прогноз.Месяц]
		)
	)
	/
	(
		Count(total distinct [ДатаПрогноза.Прогноз.Месяц])
		-
		1
	)
) * 3
"
exp_СкидкаОтПрайса;"
Sum({<[Вид продажи] = {'Обычная продажа'}, Собственные = {0}>} [СкидкаОтПрайса])
"
exp_СкидкаОтПрайса_USD;"
Sum
(
  {<$(set_УсловияСравненияСоСкидками2)>}
  [СкидкаОтПрайса]
)
"
exp_СкидкаОтПрайса_Раз;"
Count
(
  DISTINCT 
  {<$(set_УсловияСравненияСоСкидками2)
  , [СкидкаОтПрайса] = {""<0""}>} 
  %Реализация
)
"
exp_СкидкаОтПрайсаДляСравненияСоСделками_Раз;"
(
  Count
  (
    {<$(set_УсловияСравненияСоСкидками1),
    [СкидкаОтПрайса] = {""<0""}>} 
    DISTINCT %Реализация
  )
)
*
-1
"
exp_СкидкаОтПрайсаДоля;"
If
(
  Sum
  (
    {<$(set_УсловияСравненияСоСкидками2)>} 
    [СтоимостьПартии]
  ) 
  = 0
  , 0
  , Sum
  (
    {<$(set_УсловияСравненияСоСкидками2)>} 
    [СкидкаОтПрайса]
  ) 
  / Sum
  (
    {<$(set_УсловияСравненияСоСкидками2)>} 
    [СтоимостьПартии]
  )
)
"
exp_Скользящая;"
Above
(
	(
		(
			Sum({<$(set_УсловияПродажПрогноз), _FlagSumMonthYear={1}>} Стоимость)
			+
			Sum({<$(set_УсловияПродажПрогноз), _FlagSumMonthYear={1}>} СуммаЗащиты)
			+
			Sum
			(
				{<$(set_УсловияПродажПрогноз), _FlagSumMonthYear={1}>} 
				[СуммаВозвратаНДС]
				*
				[Продано единиц]
			)
			-
			Sum({<$(set_УсловияПродажПрогноз), _FlagSumMonthYear={1}>} ПроцентВложений)
		)
		-
		(
			Sum
			(
				{<$(set_УсловияПродажПрогноз), _FlagSumMonthYear={1}>} 
				[Первая себестоимость] 
				* 
				[Продано единиц]
			)
		)
	)
	, 1
) 
* 
If
(
	RowNo() = 1
	,
	$(exp_КоэфСезонОчищ) / Bottom($(exp_КоэфСезонОчищ))
	,
	$(exp_КоэфСезонОчищ) / Above($(exp_КоэфСезонОчищ), 1)
)
"
exp_СкоростьПродажиПоРеал;"
Sum({<$(set_УсловияПродаж), [ТоварНаРеализации] = {'Да'}, [Продано единиц] = {""> 0""}>} [Продано единиц]) 
/
(
  Max({<$(set_УсловияПродаж), [Продано единиц] = {""> 0""}, [ТоварНаРеализации] = {'Да'}>} Дата) 
  - 
  Min({<$(set_УсловияПродаж), [Продано единиц] = {""> 0""}, [ТоварНаРеализации] = {'Да'}>} %ДатаРеал)
)
"
exp_СрВремяПродажиПоРеал;"
Avg
(
  Aggr
  (
    Only
    (
      {<$(set_УсловияПродаж), [Продано единиц] = {""> 0""}, [ТоварНаРеализации] = {'Да'}>} 
      Дата
    ) 
    - 
    %ДатаРеал
    , Дата, %Регистратор, [Номенклатура], [Контрагент], [Категория]
  )
)
"
exp_СреднемесячныйОборот;"
Sum
(
	Aggr
	(
		Sum({<$(set_УсловияПродаж)>} [Стоимость])
		, [МесяцГод], [Контрагент]
	)
) 
/ 
Count({<$(set_УсловияСреднийЧек)>} Distinct [МесяцГод])
"
exp_СредниеПродажи_Шт;"
Sum({<$(set_УсловияПродаж), Дата = {""$(=Min(Дата))""}>} [Продано единиц])
"
exp_СреднийТЗвДень_себ;"
(
	(
		Sum({<FMStart = {1}>} [ПерваяСебОстатка] * Остаток)
  -
  (
    Sum
    (
      {<Дата = {""$(=MonthStart(Min(total Дата)))""}>} 
      [ПерваяСебОстатка] * Остаток
    ) / 2
  )
  -
  (
    Sum
    (
      {<Дата = {""$(=MonthStart(Max(total Дата)))""}>} 
      [ПерваяСебОстатка] * Остаток
    ) / 2
  )
	) 
	/ 
	(
    (
      Max(total Дата) - Min(total Дата)
    ) - 1
  )
)
"
exp_СреднийЗапасТекущий;"
(
	Sum
	(
		Aggr
		(
			Sum
			(
				{<Номенклатура=, Категория=, Склад=, Бренд=, FCY ={1}, [Год]=, [Месяц]=, Организация = {$(set_ОсновныеОрганизации)}>} 
				Остаток
			)
			, [Номенклатура], Склад, [Год], [Месяц], Дата
		)
	) 
	-
	(
		Sum
		(
			{<Номенклатура=, Категория=, Склад=, Бренд=, FCY ={1}, [Год]=, [Месяц]=, Организация = {$(set_ОсновныеОрганизации)}, Дата = {""=Rank(Дата, 4)=1""}>} 
			Остаток
		)
		/
		2
	) 
	- 
	(
		Sum
		(
			{<Номенклатура=, Категория=, Склад=, Бренд=, FCY ={1}, [Год]=, [Месяц]=, Организация = {$(set_ОсновныеОрганизации)}, Дата = {""=Rank(Дата, 3)=1""}>} 
			Остаток
		)
		/
		2
	)
) 
/ 
(
	Count
	(
		{<Номенклатура=, Категория=, Склад=, Бренд=, FCY ={1}, [Год]=, [Месяц]=, Организация = {$(set_ОсновныеОрганизации)}>} 
		Дата
	)
	-
	1
)
"
exp_СреднийТЗ_себ;"
(
  Sum({<FMStart = {1}>} [ПерваяСебОстатка] * Остаток)
  -
  (
    Sum
    (
      {<Дата = {""$(=MonthStart(Min(total Дата)))""}>} 
      [ПерваяСебОстатка] * Остаток
    ) / 2
  )
  -
  (
    Sum
    (
      {<Дата = {""$(=MonthStart(Max(total Дата)))""}>} 
      [ПерваяСебОстатка] * Остаток
    ) / 2
  )
)
"
exp_СреднийТЗ_Шт;"
Floor
(
  Sum({<FMStart = {1}>} Остаток)
  -
  (
    Sum
    (
      {<Дата = {""$(=MonthStart(Min(total Дата)))""}>} 
      Остаток
    ) / 2
  )
  -
  (
    Sum
    (
      {<Дата = {""$(=MonthStart(Max(total Дата)))""}>} 
      Остаток
    ) / 2
  )
)
"
exp_СреднийТЗвМесяц_Шт;"
Floor
(
  (
    Sum({<FMStart = {1}>} Остаток)
    -
    (
      Sum
      (
        {<Дата = {""$(=MonthStart(Min(total Дата)))""}>} 
        Остаток
      ) / 2
    )
    -
    (
      Sum
      (
        {<Дата = {""$(=MonthStart(Max(total Дата)))""}>} 
        Остаток
      ) / 2
    )
  ) 
  / 
  (
    $(func_MonthDiff(Min(total Дата), Max(total Дата)))
  )
)
"
exp_СреднийТЗвМесяц_себ;"
(
  Sum({<FMStart = {1}>} [ПерваяСебОстатка] * Остаток)
  -
  (
    Sum
    (
      {<Дата = {""$(=MonthStart(Min(total Дата)))""}>} 
      [ПерваяСебОстатка] * Остаток
    ) / 2
  )
  -
  (
    Sum
    (
      {<Дата = {""$(=MonthStart(Max(total Дата)))""}>} 
      [ПерваяСебОстатка] * Остаток
    ) / 2
  )
) 
/ 
(
  $(func_MonthDiff(Min(total Дата), Max(total Дата)))
)
"
exp_СреднийЧек;"
Sum({<$(set_УсловияСреднийЧек)>} [СтоимостьСНДС]) 
/ 
Count({<$(set_УсловияСреднийЧек)>} Distinct [%Регистратор])
"
exp_СреднийЧек_total;"
Sum
(
	total Aggr
	(
		(
      Sum({<$(set_УсловияСреднийЧек)>} [СтоимостьСНДС]) 
      / 
      Count({<$(set_УсловияСреднийЧек)>} Distinct [%Регистратор])
    ), $(exp_Измерение)
	)
)
"
exp_СреднийЧекPYTD;"
Sum({<$(set_УсловияСреднийЧек), $(set_УсловияPYTD)>} [СтоимостьСНДС])
/ 
Count({<$(set_УсловияСреднийЧек), $(set_УсловияPYTD)>} Distinct %Регистратор)
"
exp_СреднийЧекYTD;"
Sum({<$(set_УсловияСреднийЧек), $(set_УсловияYTD)>} [СтоимостьСНДС])
/ 
Count({<$(set_УсловияСреднийЧек), $(set_УсловияYTD)>} Distinct %Регистратор)
"
exp_СреднийЧекYTY;"
Sum({<$(set_УсловияСреднийЧек), $(set_УсловияYTY)>} [СтоимостьСНДС])
/ 
Count({<$(set_УсловияСреднийЧек), $(set_УсловияYTY)>} Distinct %Регистратор)
"
exp_СреднийЧекПрошлый;"
Sum({1 <$(set_УсловияСреднийЧек), FLY={1}>} 
	Aggr({1 <$(set_УсловияСреднийЧек), FLY={1}>} 
		Sum({<$(set_УсловияСреднийЧек), FLY={1}>}[СтоимостьСНДС])
		, [%Регистратор], [Контрагент]
	)
) 
/ 
Sum({1 <$(set_УсловияСреднийЧек), FLY={1}>}
	Aggr({1 <$(set_УсловияСреднийЧек), FLY={1}>} distinct
		Count({1 <$(set_УсловияСреднийЧек), FLY={1}>} Distinct %Регистратор)
		, [Год], [Месяц], Контрагент
	)
)
"
exp_СреднийЧекТекущий;"
Sum({1 <$(set_УсловияСреднийЧек), FCY={1}>} 
	Aggr({1 <$(set_УсловияСреднийЧек), FCY={1}>} 
		Sum({<$(set_УсловияСреднийЧек), FCY={1}>}[СтоимостьСНДС])
		, [%Регистратор], [Контрагент]
	)
) 
/ 
Sum({1 <$(set_УсловияСреднийЧек), FCY={1}>}
	Aggr({1 <$(set_УсловияСреднийЧек), FCY={1}>} distinct
		Count({1 <$(set_УсловияСреднийЧек), FCY={1}>} Distinct %Регистратор)
		, [Год], [Месяц], Контрагент
	)
)
"
exp_СредняяСкоростьПродаж;"
Aggr
(
  Sum([Продано единиц])
  , [МесяцГод]
)
/ 
Count(distinct [МесяцГод])
"
exp_СрТоварныйЗапасВТекущемГоду;"
(
  Sum
  (
    {<$(set_УсловияПокТекГод)>} 
    Aggr
    (
      {<$(set_УсловияПокТекГод)>} 
      Sum({<$(set_УсловияПокТекГод)>} Остаток)
      , Номенклатура, Склад, Год, Месяц, Дата
    )
  ) 
  -
  (
    Sum({<Дата = {""=Rank(Дата, 4)=1""}, $(set_УсловияПокТекГод)>} Остаток)
    /
    2
  ) 
  - 
  (
    Sum({<Дата = {""=Rank(Дата, 3)=1""}, $(set_УсловияПокТекГод)>} Остаток)
    /
    2
  )
) 
/ 
(
  Count({<$(set_УсловияПокТекГод)>} Дата)
  -
  1
)
"
exp_СрЧекВТекущемГоду;"
Sum({<$(set_УсловияСреднийЧек), FCY={1}>} [СтоимостьСНДС]) 
/ 
Count({<$(set_УсловияСреднийЧек), FCY={1}>} Distinct [%Регистратор])
"
exp_СрЧекПоИзмерению;"
Sum({<$(set_УсловияСреднийЧек)>}
	Aggr({<$(set_УсловияСреднийЧек)>}
		Sum({<$(set_УсловияСреднийЧек)>} [СтоимостьСНДС])
		, %Регистратор, $(exp_Измерение)
	)
)
/ 
Sum({<$(set_УсловияСреднийЧек)>} 
	Aggr({<$(set_УсловияСреднийЧек)>} distinct
		Count({<$(set_УсловияСреднийЧек)>} Distinct %Регистратор)
		, [Месяц], $(exp_Измерение)
	)
)
"
exp_СрЧекПоИзмерению_total;"
Sum
({<$(set_УсловияСреднийЧек)>} total 
	Aggr({<$(set_УсловияСреднийЧек)>} 
		Sum({<$(set_УсловияСреднийЧек)>} [СтоимостьСНДС])
		, [%Регистратор], $(exp_Измерение)
	)
) 
/
Sum({<$(set_УсловияСреднийЧек)>} total
	Aggr({<$(set_УсловияСреднийЧек)>} distinct
		Count({<$(set_УсловияСреднийЧек)>} Distinct %Регистратор)
		, [Месяц], $(exp_Измерение)
	)
)
"
exp_СтоимостьОстаткаНаРеал;"
Round
(
  Sum
  (
    {<Дата = {""=rank(Дата, 4) = 1""}>} 
    [ОстатокНаРеализации] 
    *	
    Aggr(ЦенаНаРеализации, %Регистратор, %СерияОстаткаРеализации)
  ) 
  / 
  Only({<Дата = {""=rank(Дата, 4) = 1""}>} КурсUSD)
  , 0.01
)
"
exp_СтоимостьОстаткаНаРеалНаКонецМесяца;"
Round
(
  (
    Sum({<FMEnd = {1}>} [ОстатокНаРеализации]) 
    / 
    Avg
    (
      Aggr
      (
        Avg([КурсUSDРеализации])
        , %Регистратор, %СерияОстаткаРеализации
      )
    )
  ) 
  * 
  Avg
  (
    Aggr
    (
      nodistinct Avg([ЦенаНаРеализации])
      , %Регистратор, %СерияОстаткаРеализаци
    )
  )
  , 0.01
)
"
exp_СтоимостьОстатковНаКонецМесяцаПоТекущей6Х;"
Sum
(
  Aggr
  (
    Sum(FMEnd * Остаток * [6X])
    , %СерияОстатка, [Номенклатура]
  )
)
/
Only({<FMEnd = {1}>} [КурсUSD])
"
exp_СуммаВложенийНаДатуОтгрузки_USD;"
Sum({<$(set_УсловияПродаж)>} $(exp_РасчетВложений))
"
exp_СуммаВложений;"
Sum({<$(set_УсловияПродаж)>} [ПроцентВложений])
"
exp_СуммаВложенийОстатков_USD;"
Sum
(
  Aggr
  (
    Sum
    (
      [СуммаПлатежаОстатка] 
      * 
      (
        [СтавкаПроцентаОстатка] 
        * 
        (
          Max(total [Дата]) 
          - 
          [ДатаПлатежаОстатка] 
          + 
          1
        ) 
        / 
        365
      )
    )
    *
    (
      Sum({<Дата = {""=rank(Дата, 4) = 1""}>} Остаток)
    ), Склад, %СерияОстатка, [ДатаПлатежаОстатка]
  )
)
"
exp_СуммаВложенийОстатковНаЕдТовара_USD;"
If
(
  (
    Sum({<Дата = {""=rank(Дата, 4) = 1""}>} Остаток)
  ) 
  > 0
  , Max
  (
    Aggr
    (
      {<Дата = {""=rank(Дата, 4) = 1""}>} 
      Sum
      (
        [СуммаПлатежаОстатка] 
        * 
        (
          [СтавкаПроцентаОстатка] 
          * 
          (
            Max(total [Дата]) 
            - 
            [ДатаПлатежаОстатка] 
            + 
            1
          ) 
          / 
          365
        )
      )
      , Склад, %СерияОстатка, [ДатаПлатежаОстатка]
    )
  )
)
"
exp_СуммаЗащиты;"
Sum({<$(set_УсловияПродаж)>} [СуммаЗащиты])
"
exp_ТОПпродаж;"
Sum({<[Менеджер] = {""=rank(sum({<Собственные = {0}>} СтоимостьСНДС), 4)<= $(vКоличествоТопПродаж)""}, Собственные = {0}>} СтоимостьСНДС)
"
exp_ТрендВалПрибыли;"
RangeAvg
(
  RangeAvg
  (
    Above
    (
      $(exp_ВаловаяПрибыль)
      , -1, 10
    )
  )
  , 
  RangeAvg
  (
    Above($(exp_ВаловаяПрибыль), 0, 10)
  )
)
"
exp_ТрендОстатков;"
RangeAvg
(
  RangeAvg
  (
    Above(Sum([Остаток]), -1, 100)
  )
  , 
  RangeAvg(
    Above(Sum([Остаток]), 0, 100)
  )
)
"
exp_ТрендОстатковНаКонецПериода;"
RangeAvg
(
  RangeAvg
  (
    Above
    (
      Sum
      (
        RangeMax(FMEnd, FYEnd) 
        * 
        Остаток
      )
      , -1, 100
    )
  )
  , 
  RangeAvg
  (
    Above
    (
      Sum
      (
        RangeMax(FMEnd, FYEnd) 
        * 
        Остаток
      )
      , 0, 100
    )
  )
)
"
exp_УдВесДолга;"
Sum
(
  {<СуммаРеализацииУпр = {""> $(vСуммаРеализации)""}, Собственные = {0}, ПДЛГ = {1}, Долг = {""> 1""}>} 
  Долг 
  * 
  [Дни долга]
)
"
exp_УровеньЗапасовПродукции;"
($(exp_ОстатокНаПоследДату_Шт))
*
(
  Max(total Дата) - Min(total Дата)
)
/
($(exp_ПроданоЕдиниц))
"
exp_ЦенаТовараНаРеал;"
Avg
(
  Aggr
  (
    nodistinct Avg({<[ТоварНаРеализации] = {'Да'}>} [ЦенаНаРеализации])
    , %Регистратор, %СерияОстаткаРеализации
  )
)
"
exp_ЦенаТовараНаРеалUSD;"
Avg
(
  Aggr
  (
    nodistinct Avg({<[ТоварНаРеализации] = {'Да'}>} [ЦенаНаРеализации])
    , %Регистратор, %СерияОстаткаРеализации
  )
)
/
Avg
(
  Aggr
  (
    Avg({<[ТоварНаРеализации] = {'Да'}>} [КурсUSDРеализации])
    , %Регистратор, %СерияОстаткаРеализации
  )
)
"
